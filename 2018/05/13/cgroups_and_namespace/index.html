<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Cgroups and Namespace"><meta name="keywords" content=""><meta name="author" content="YYY,undefined"><meta name="copyright" content="YYY"><title>Cgroups and Namespace | XXX</title><link rel="shortcut icon" href="/blog/favicon.ico"><link rel="stylesheet" href="/blog/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.4"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  localSearch: undefined
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Cgroups"><span class="toc-number">1.</span> <span class="toc-text">Cgroups</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Subsystem"><span class="toc-number">1.1.</span> <span class="toc-text">Subsystem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-use-cgroup"><span class="toc-number">1.2.</span> <span class="toc-text">How to use cgroup?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#other"><span class="toc-number">1.2.1.</span> <span class="toc-text">other</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Namespace"><span class="toc-number">2.</span> <span class="toc-text">Namespace</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Usage"><span class="toc-number">3.</span> <span class="toc-text">Usage</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">4.</span> <span class="toc-text">Reference</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#temporary-note-from-youdao"><span class="toc-number">5.</span> <span class="toc-text">temporary note from youdao</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#terminlogy-in-cgroup"><span class="toc-number">5.1.</span> <span class="toc-text">terminlogy in cgroup:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hierarchy"><span class="toc-number">5.1.1.</span> <span class="toc-text">hierarchy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#group"><span class="toc-number">5.1.2.</span> <span class="toc-text">group</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#subsystem"><span class="toc-number">5.1.3.</span> <span class="toc-text">subsystem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#controllers"><span class="toc-number">5.1.4.</span> <span class="toc-text">controllers</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Terminlonogy"><span class="toc-number">6.</span> <span class="toc-text">Terminlonogy</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TODO"><span class="toc-number">7.</span> <span class="toc-text">TODO</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/blog/img/avatar.png"></div><div class="author-info__name text-center">YYY</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/blog/archives"><span class="pull-left">Articles</span><span class="pull-right">13</span></a><a class="author-info-articles__tags article-meta" href="/blog/tags"><span class="pull-left">Tags</span><span class="pull-right">1</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories"><span class="pull-left">Categories</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/blog/">XXX</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">Cgroups and Namespace</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-05-13</time><span class="post-meta__separator">|</span><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/blog/categories/jekyll-update/"> jekyll update</a></div><div id="post-content"><h1 id="Cgroups"><a href="#Cgroups" class="headerlink" title="Cgroups"></a>Cgroups</h1><p>To put it simple, cgroups are a metering and limiting mechanism, they control<br>how much of a system resource (CPU, memory) you can use. On the other hand,<br>namespaces limit what you can see. Thanks to namespaces processes have their<br>own view of the system’s resources.</p>
<h2 id="Subsystem"><a href="#Subsystem" class="headerlink" title="Subsystem"></a>Subsystem</h2><p><em>hierarchy</em>: combination of subsystem. subsystem can only be part of single hierarchy</p>
<p><em>control group</em>: subdirectory of the hierarchy, it further limit the resource of its task other than the configuration of its parent group</p>
<h2 id="How-to-use-cgroup"><a href="#How-to-use-cgroup" class="headerlink" title="How to use cgroup?"></a>How to use cgroup?</h2><p><em>Command</em></p>
<ul>
<li><p>cgexec</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cgexec -g blkio:test1 dd if=file-abc of=/dev/null</span><br></pre></td></tr></table></figure>
</li>
<li><p>cgdelete subsystems:path</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">where:</span><br><span class="line">    subsystems is a comma‑separated list of subsystems.</span><br><span class="line">    path is the path to the cgroup relative to the root of the hierarchy.</span><br><span class="line"></span><br><span class="line">As i know, this command will echo msg like &apos;cgdelete: cannot remove group &apos;hubble-agent&apos;: No such file or directory&apos;, but it succeeds most of the time</span><br></pre></td></tr></table></figure>
</li>
<li><p>create a control group</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cgcreate -t uid:gid -a uid:gid -g controllers:path</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>controllers is not necessary to the subsystem combination</p>
<ul>
<li>lssubsys</li>
</ul>
<p>lscgroup</p>
<p>configuration</p>
<p>subsystem</p>
<h3 id="other"><a href="#other" class="headerlink" title="other"></a>other</h3><ol>
<li>/proc/<pid>/cgroup provides with list of hierarchy and corresponding control group that this process belongs to</pid></li>
</ol>
<h1 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h1><p>Network namespaces</p>
<hr>
<h1 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h1><p><strong>Tools</strong></p>
<ul>
<li>nsenter</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote>
<p><a href="https://blogs.igalia.com/dpino/2016/04/10/network-namespaces/" target="_blank" rel="noopener">https://blogs.igalia.com/dpino/2016/04/10/network-namespaces/</a></p>
</blockquote>
<blockquote>
<p><a href="http://cizixs.com/2017/02/10/network-virtualization-network-namespace" target="_blank" rel="noopener">Network Namespace</a></p>
</blockquote>
<hr>
<h1 id="temporary-note-from-youdao"><a href="#temporary-note-from-youdao" class="headerlink" title="temporary note from youdao"></a>temporary note from youdao</h1><h2 id="terminlogy-in-cgroup"><a href="#terminlogy-in-cgroup" class="headerlink" title="terminlogy in cgroup:"></a>terminlogy in cgroup:</h2><pre><code>1. https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-relationships_between_subsystems_hierarchies_control_groups_and_tasks
2. usage and tools
https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/resource_management_guide/sec-default_cgroup_hierarchies
</code></pre><h3 id="hierarchy"><a href="#hierarchy" class="headerlink" title="hierarchy"></a>hierarchy</h3><h3 id="group"><a href="#group" class="headerlink" title="group"></a>group</h3><h3 id="subsystem"><a href="#subsystem" class="headerlink" title="subsystem"></a>subsystem</h3><h3 id="controllers"><a href="#controllers" class="headerlink" title="controllers"></a>controllers</h3><pre><code>Never use libcgropup tools to modify the default hierarchies mounted by systemd since it would lead to unexpected behavior. The libcgroup library will be removed in future versions of Red Hat Enterprise Linux. 
</code></pre><p>systemd  <a href="https://linuxaria.com/article/how-to-manage-processes-with-cgroup-on-systemd" target="_blank" rel="noopener">https://linuxaria.com/article/how-to-manage-processes-with-cgroup-on-systemd</a><br>    So Control Groups are two things: (A) a way to hierarchally group and label processes, and (B) a way to then apply resource limits to these groups. systemd only requires the former (A), and not the latter (B).</p>
<pre><code>systemctl kill auditd.service
# systemctl kill -s SIGKILL auditd.service


 systemd-cgtop  for resource usage monitoring, 可以看看这个方法能否快速实现进程网络io的统计
 systemd-cgls
</code></pre><p>systemd + cgroup, i think it’s a good combination</p>
<p>cgroup:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Multiple separate hierarchies of cgroups are necessary because each hierarchy is attached to one or more subsystems.</span><br></pre></td></tr></table></figure></p>
<p>cmd to mount cgroup:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t cgroup -o cpuset,memory hier1 /sys/fs/cgroup/rg1</span><br></pre></td></tr></table></figure></p>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-relationships_between_subsystems_hierarchies_control_groups_and_tasks" target="_blank" rel="noopener">cgroup tutorial</a></p>
<h1 id="Terminlonogy"><a href="#Terminlonogy" class="headerlink" title="Terminlonogy"></a>Terminlonogy</h1><p>subsystem, cgroup, hierarchy and task ?</p>
<p>这个文章一定程度上暗示了什么是hierarchy: <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/ch-using_control_groups" target="_blank" rel="noopener">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/ch-using_control_groups</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Note that multiple subsystems can be mounted to a single hierarchy, but each subsystem can be mounted only once.</span><br></pre></td></tr></table></figure></p>
<p><strong>Command</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">列出subsystem是否挂载，挂到哪个hierarchy上？</span><br><span class="line"># lssubsys -am</span><br><span class="line"></span><br><span class="line">Creating a mount entry，通过配置文件和命令的挂载方法？</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">重新调整hierarchy所挂载的subsystem: 使用 -o remount,[subsystem combination]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stat: /proc/cgroups</span><br><span class="line"></span><br><span class="line">how to show all the hierarchy directory?  lssubsys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">怎样列出 sussystems 下的所有hierarchy目录？ lssubsys -am只能显示一个，是不是说多个目录最终都映射到同一个中？ 我测试了一下，应该使用类似软连接的技术，我同时将同一个subsystem combination挂载到多个hierarchy下，重新remount其中一个，都会影响所有hierarchy。 同时，这意味着将所有相关的hierarchy umount后才能将subsystem combination释放掉，即unmount其中一个不会影响其他。 向其中一个hierarchy加入group，会影响其他的hierarchy目录。 测试了那么多，归根到底，只要在hierarchy下创建了group，直到你cgdelete这个group为止，这个hierarchy都会存在，即是是umount hierarchy</span><br><span class="line"></span><br><span class="line">cgdelete并不会杀死group里面的task进程</span><br><span class="line"></span><br><span class="line">lssubsys  列出所有的hierarchy，默认情况下hierarchy名为subsystem名</span><br><span class="line">lssubsys -a 列出所有的subsystem</span><br><span class="line">lssubsys -am</span><br></pre></td></tr></table></figure></p>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-relationships_between_subsystems_hierarchies_control_groups_and_tasks" target="_blank" rel="noopener">Rule</a></p>
<ol>
<li>subsystem特定的组合后，不能再切割或变成一个子组合。  这应该是rule 2</li>
</ol>
<h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ol>
<li>研究systemd and cgroup，他们怎样组合一起使用？</li>
<li>umount <hierarchy>的副作用以及怎样解决？</hierarchy></li>
<li>/proc/mounts  headers解析，比如第一列是device name</li>
<li>当group还有task正在运行时， mount 和 mount -o remount[,xxx] 会报 <strong>mount: <hierarchy dir=""> is busy</hierarchy></strong>。 就算你umount了，由于group信息仍然残留在kernel中，<strong>lssubsys</strong> 和 <strong>lssubsys -a</strong>依然会显示这个subsystem combination，但是 <strong>lssubsys -am</strong>不会显示，因为没有mount point</li>
<li>if umounting hierarchy while there are still some running group, the hierarchy info skill exists in the kernel. You can not mount any subsystem within that hierarchy until you delete those group</li>
<li>[investigate systemd, its unit system and combination with cgroup] (<a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/resource_management_guide/sec-modifying_control_groups" target="_blank" rel="noopener">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/resource_management_guide/sec-modifying_control_groups</a>)</li>
</ol>
<p><a href="https://en.wikipedia.org/wiki/Systemd" target="_blank" rel="noopener">这个layer char不错</a></p>
<p>apply systemd config change:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl restart example.service</span><br></pre></td></tr></table></figure></p>
<ol start="7">
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-limit-resources-using-cgroups-on-centos-6" target="_blank" rel="noopener">how to let cgroup mount all the subsystem on start up for centos 6.x</a></li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">YYY</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/05/13/cgroups_and_namespace/">http://yoursite.com/2018/05/13/cgroups_and_namespace/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/blog/2018/05/13/component-interactive/"><i class="fa fa-chevron-left">  </i><span>Conponent Interaction in Coding</span></a></div><div class="next-post pull-right"><a href="/blog/2018/05/13/big data/"><span>Big Data</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2018 By YYY</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/blog/js/third-party/anime.min.js"></script><script src="/blog/js/third-party/jquery.min.js"></script><script src="/blog/js/third-party/jquery.fancybox.min.js"></script><script src="/blog/js/third-party/velocity.min.js"></script><script src="/blog/js/third-party/velocity.ui.min.js"></script><script src="/blog/js/utils.js?version=1.5.4"></script><script src="/blog/js/fancybox.js?version=1.5.4"></script><script src="/blog/js/sidebar.js?version=1.5.4"></script><script src="/blog/js/copy.js?version=1.5.4"></script><script src="/blog/js/fireworks.js?version=1.5.4"></script><script src="/blog/js/transition.js?version=1.5.4"></script><script src="/blog/js/scroll.js?version=1.5.4"></script><script src="/blog/js/head.js?version=1.5.4"></script></body></html>